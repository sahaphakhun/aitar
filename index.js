// ------------------------
// server.js (à¹‚à¸„à¹‰à¸”à¸—à¸µà¹ˆ 2 à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸­à¸±à¸›à¹€à¸”à¸•)
// ------------------------
const express = require('express');
const bodyParser = require('body-parser');
const request = require('request');
const { OpenAI } = require('openai');
const { MongoClient } = require('mongodb');

// à¸ªà¸£à¹‰à¸²à¸‡ Express App
const app = express();
const PORT = process.env.PORT || 3000;

// à¸•à¸±à¸§à¹à¸›à¸£ Environment
const VERIFY_TOKEN = process.env.VERIFY_TOKEN || "XianTA1234";
const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const MONGO_URI = process.env.MONGO_URI;

// à¸ªà¸£à¹‰à¸²à¸‡ OpenAI Instance
const openai = new OpenAI({
  apiKey: OPENAI_API_KEY, // à¹ƒà¸Šà¹‰ API key à¸ˆà¸²à¸ Environment Variable
});

// à¸›à¸£à¸°à¸à¸²à¸¨à¸•à¸±à¸§à¹à¸›à¸£ client à¹à¸šà¸š Global (à¹ƒà¸Šà¹‰à¸£à¹ˆà¸§à¸¡à¸à¸±à¸™)
let mongoClient = null;

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MongoDB (à¹à¸šà¸š global client)
async function connectDB() {
  if (!mongoClient) {
    mongoClient = new MongoClient(MONGO_URI);
    await mongoClient.connect();
    console.log("MongoDB connected (global client).");
  }
  return mongoClient;
}

// à¹ƒà¸Šà¹‰ bodyParser
app.use(bodyParser.json());

// ------------------------
// System Instructions (à¹„à¸¡à¹ˆà¹à¸à¹‰à¹„à¸‚à¸«à¸£à¸·à¸­à¸•à¸±à¸”à¸—à¸­à¸™)
// ------------------------
const systemInstructions = `

à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¹à¸­à¸”à¸¡à¸´à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹à¸¥à¸°à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¹€à¸žà¸ˆ Facebook  
à¹‚à¸›à¸£à¸”à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸•à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸£à¸šà¸–à¹‰à¸§à¸™ à¹‚à¸”à¸¢à¹ƒà¸«à¹‰à¸„à¸³à¸•à¸­à¸šà¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸™à¸¸à¸©à¸¢à¹Œà¸ˆà¸£à¸´à¸‡ à¹†  
à¹à¸¥à¸°à¸•à¸­à¸šà¸•à¸£à¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹ƒà¸” à¹† à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡  
à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸Šà¸´à¸‡à¸¥à¸¶à¸ à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ˆà¸²à¸ 6) à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) à¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸­à¸š (à¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸™à¸¸à¸©à¸¢à¹Œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹ƒà¸” à¹† à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡  à¹à¸•à¹ˆà¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸à¸²à¸£à¸‹à¸·à¹‰à¸­à¸ªà¸´à¸™à¸„à¹‰à¸² à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸¸à¸¢à¹€à¸¥à¹ˆà¸™à¹„à¸”à¹‰à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢
  (à¹€à¸Šà¹ˆà¸™ à¸•à¸­à¸™à¹à¸£à¸ à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸„à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ à¸„à¸¸à¸“à¹à¸ˆà¹‰à¸‡à¹„à¸›à¹à¸¥à¹‰à¸§ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸„à¸² à¸«à¹‰à¸²à¸¡à¸žà¸¹à¸”à¸–à¸¶à¸‡à¸£à¸²à¸„à¸²à¸‹à¹‰à¸³)  
â€¢ à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸­à¸´à¹‚à¸¡à¸ˆà¸´ à¸à¸²à¸£à¹€à¸§à¹‰à¸™à¸§à¸£à¸£à¸„ à¸«à¸£à¸·à¸­à¹€à¸§à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸” à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¸­à¹ˆà¸²à¸™à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ (à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹ƒà¸Šà¹‰à¸­à¸´à¹‚à¸¡à¸ˆà¸´à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰ ðŸ”¥, âœ¨, âœ…, âŒ à¹à¸¥à¸°à¸­à¸´à¹‚à¸¡à¸ˆà¸´à¸­à¸·à¹ˆà¸™ à¹† à¹ƒà¸«à¹‰à¹„à¸”à¹‰à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸” à¹€à¸Šà¹ˆà¸™à¹€à¸¡à¸·à¹ˆà¸­à¸•à¸­à¸™à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸„à¸²)   
â€¢ à¸ˆà¸”à¸ˆà¸³à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸™à¹ƒà¸ˆà¹„à¸§à¹‰ à¹à¸¥à¸° **à¹„à¸¡à¹ˆà¸–à¸²à¸¡à¸‹à¹‰à¸³** à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§  
  (à¸¢à¸à¹€à¸§à¹‰à¸™à¸à¸²à¸£à¸„à¸­à¸™à¹€à¸Ÿà¸´à¸£à¹Œà¸¡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸—à¹‰à¸²à¸¢à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²)  
â€¢ à¹€à¸£à¸µà¸¢à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² â€œà¸„à¸¸à¸“à¸žà¸µà¹ˆâ€ à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸ªà¸£à¸£à¸žà¸™à¸²à¸¡ â€œà¸„à¸£à¸±à¸šâ€ (à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸Šà¸²à¸¢)  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸­à¸šà¸–à¸²à¸¡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸² (à¹€à¸Šà¹ˆà¸™ à¸‚à¸™à¸²à¸”, à¸£à¸²à¸„à¸²) à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹€à¸‰à¸žà¸²à¸°à¸—à¸µà¹ˆà¸–à¸¹à¸à¸–à¸²à¸¡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¢à¸·à¸”à¹€à¸¢à¸·à¹‰à¸­  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸žà¸´à¸¡à¸žà¹Œ â€œà¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡â€ à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸§à¹ˆà¸²à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (COD) à¹à¸•à¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š COD  
â€¢ à¸‚à¸­à¸Šà¸·à¹ˆà¸­-à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸ˆà¸±à¸”à¸ªà¹ˆà¸‡ **à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸** à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸ªà¸¥à¸´à¸›à¸à¸²à¸£à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¹‚à¸­à¸™ 
â€¢ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸²à¸ˆà¸°à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¹„à¸«à¸™ à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸§à¹ˆà¸²à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¹€à¸ªà¸¡à¸­
â€¢ **à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°** à¹€à¸¡à¸·à¹ˆà¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸”à¸¹à¸£à¸¹à¸›à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™  
  - à¸«à¸²à¸à¸‚à¸­à¸£à¸¹à¸›à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­à¸ªà¸²à¸¢à¸„à¸²à¸”: "[SEND_IMAGE_SROI:https://i.imgur.com/OgW7m9x.jpeg]"
  - à¸«à¸²à¸à¸‚à¸­à¸£à¸¹à¸› â€œà¸‚à¸™à¸²à¸”à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­à¹‚à¸”à¸¢à¸›à¸£à¸°à¸¡à¸²à¸“â€: "[SEND_IMAGE_LENGTH:https://i.imgur.com/S6TiC4R.jpeg]"
â€¢ **à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆ [SEND_IMAGE_...]** à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸žà¸´à¸¡à¸žà¹Œà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¸£à¸¹à¸›à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”   (à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸‚à¸­à¸”à¸¹à¸£à¸¹à¸›à¸¡à¸²à¸à¹ˆà¸­à¸™) 
â€¢ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸‚à¸­à¸£à¸¹à¸›à¸‹à¹‰à¸³ à¸­à¸¢à¹ˆà¸²à¹ƒà¸ªà¹ˆ [SEND_IMAGE_SROI:â€¦] à¸‹à¹‰à¸³, à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸£à¸¹à¸›à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§à¸à¹‡à¸„à¸§à¸£à¹ƒà¸ªà¹ˆà¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§
â€¢ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸–à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¸«à¸£à¸·à¸­à¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸” à¹† à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸² à¹ƒà¸«à¹‰à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ â€œà¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸´à¸–à¸²à¸¡...â€ à¸«à¸£à¸·à¸­ â€œà¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•...â€ à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¸à¸ à¸²à¸ž  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œ à¹ƒà¸«à¹‰à¸„à¸¸à¸“à¸„à¸´à¸”à¸„à¸³à¸•à¸­à¸šà¸­à¸°à¹„à¸£à¸à¹‡à¹„à¸”à¹‰
â€¢ à¸«à¸²à¸à¸žà¸šà¸§à¹ˆà¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸› (à¸ à¸²à¸žà¸ªà¸´à¸™à¸„à¹‰à¸², à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ) à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ˆà¸°à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸§à¹ˆà¸² "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²**" à¸šà¸­à¸à¸„à¸¸à¸“
  à¸«à¸£à¸·à¸­à¸«à¸²à¸à¹€à¸›à¹‡à¸™à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸­à¸·à¹ˆà¸™ (location, file, audio à¸¯à¸¥à¸¯) à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ˆà¸°à¸ªà¹ˆà¸‡à¸§à¹ˆà¸² "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›**" à¸šà¸­à¸à¸„à¸¸à¸“
  - à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ 2 à¹à¸šà¸šà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¸³à¸žà¸¹à¸”à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸² à¹à¸•à¹ˆà¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸šà¹à¸ˆà¹‰à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸šà¸­à¸à¸„à¸¸à¸“
â€¢ à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™à¸„à¸§à¸²à¸¡à¸ˆà¸³à¹€à¸›à¹‡à¸™ à¸«à¹‰à¸²à¸¡à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸‹à¹‰à¸³ à¹† à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸•à¸­à¸šà¹„à¸›à¹à¸¥à¹‰à¸§
â€¢ à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸„à¸­à¸™à¹€à¸Ÿà¸´à¸£à¹Œà¸¡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹à¸¥à¹‰à¸§ à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² "à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸ªà¸´à¸™à¸„à¹‰à¸² à¸£à¸šà¸à¸§à¸™à¸¥à¸¹à¸à¸„à¹‰à¸² à¹à¸­à¸”à¹„à¸¥à¸™à¹Œ https://line.me/R/ti/p/@010lbhuf à¸«à¸£à¸·à¸­ à¹„à¸­à¸”à¸µà¹„à¸¥à¸™à¹Œ @xianta999 à¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸ªà¸´à¸™à¸„à¹‰à¸² à¹à¸¥à¸°à¸£à¸±à¸šà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•" à¸žà¸£à¹‰à¸­à¸¡à¸‚à¸­à¸šà¸„à¸¸à¸“à¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸¸à¸ à¸²à¸ž
â€¢  à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸„à¸­à¸™à¹€à¸Ÿà¸´à¸£à¹Œà¸¡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸–à¸²à¸¡à¸§à¹ˆà¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸™à¹ƒà¸ˆà¸­à¸°à¹„à¸£à¸­à¸µà¸ à¸¢à¸à¹€à¸§à¹‰à¸™à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸­à¸‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2) à¸ªà¸´à¸™à¸„à¹‰à¸² (à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(à¸) à¸ªà¸£à¹‰à¸­à¸¢à¸ªà¸²à¸¢à¸„à¸²à¸”à¸‚à¹‰à¸²à¸‡  
   â€¢ à¸£à¸²à¸„à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ 290 à¸šà¸²à¸— (à¸‚à¸¶à¹‰à¸™à¸­à¸¢à¸¹à¹ˆà¸à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¸­à¸‡à¸„à¹Œà¸«à¹‰à¸­à¸¢à¸žà¸£à¸°)  
   â€¢ à¸¡à¸µà¸šà¸£à¸´à¸à¸²à¸£à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (COD) à¸«à¸£à¸·à¸­à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™  
   â€¢ **à¸ˆà¸³à¸™à¸§à¸™à¸­à¸‡à¸„à¹Œà¸«à¹‰à¸­à¸¢à¸žà¸£à¸°à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸ˆà¸³à¸™à¸§à¸™à¹€à¸ªà¹‰à¸™**  
     - à¹€à¸Šà¹ˆà¸™ â€œà¸ªà¸£à¹‰à¸­à¸¢ 19 à¸­à¸‡à¸„à¹Œâ€ à¸„à¸·à¸­à¹€à¸Šà¸·à¸­à¸ 1 à¹€à¸ªà¹‰à¸™ à¸«à¹‰à¸­à¸¢à¸žà¸£à¸°à¹„à¸”à¹‰ 19 à¸­à¸‡à¸„à¹Œ  
   â€¢ à¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸ªà¸´à¸™à¸„à¹‰à¸² 7 à¸§à¸±à¸™ à¸«à¸¥à¸±à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸–à¸¶à¸‡à¸¡à¸·à¸­à¸¥à¸¹à¸à¸„à¹‰à¸² à¸«à¸²à¸à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸ªà¸²à¸¡à¸²à¸£à¸–à¹à¸ˆà¹‰à¸‡à¹€à¸„à¸¥à¸¡à¹„à¸”à¹‰
   â€¢ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸±à¹ˆà¸‡à¸—à¸³à¹€à¸›à¹‡à¸™à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­à¹„à¸”à¹‰ (à¸¥à¸”à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§) à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸ˆà¹‰à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸² à¹€à¸žà¸£à¸²à¸°à¹€à¸£à¸²à¸‚à¸²à¸¢à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸²à¸”à¸‚à¹‰à¸²à¸‡ à¹à¸•à¹ˆà¹€à¸­à¸²à¹„à¸§à¹‰à¸•à¸­à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸–à¸¶à¸‡à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­

(à¸‚) à¸ˆà¸°à¸¡à¸µà¸à¸²à¸£à¸žà¸±à¸’à¸™à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3) à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸à¸²à¸£à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¹€à¸¡à¸·à¹ˆà¸­à¸£à¸§à¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸¥à¹‰à¸§ à¹ƒà¸«à¹‰à¸šà¸§à¸à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡ 50 à¸šà¸²à¸— **à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§** à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸ˆà¸°à¸à¸µà¹ˆà¸Šà¸´à¹‰à¸™  
â€¢ à¸–à¸²à¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² â€œà¹‚à¸­à¸™ à¸«à¸£à¸·à¸­ à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡?â€ à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸²à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹‚à¸­à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™  
   1. à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (COD) (à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­à¸ªà¸²à¸¢à¸„à¸²à¸”à¸‚à¹‰à¸²à¸‡)  
   2. à¹‚à¸­à¸™à¸œà¹ˆà¸²à¸™à¸šà¸±à¸à¸Šà¸µà¸˜à¸™à¸²à¸„à¸²à¸£à¸à¸£à¸¸à¸‡à¸¨à¸£à¸µ à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸šà¸±à¸à¸Šà¸µ 768-1-09390-6 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸ªà¸«à¸ à¸²à¸„à¸„à¸¸à¸“ à¸ à¸¹à¸™à¸²à¸‚à¸²à¸§  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4) à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¸‚à¸­à¸Šà¸·à¹ˆà¸­-à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ (à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸šà¹‰à¸²à¸™, à¸•à¸³à¸šà¸¥, à¸­à¸³à¹€à¸ à¸­, à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”, à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ) à¹ƒà¸«à¹‰à¸„à¸£à¸š 5 à¸­à¸¢à¹ˆà¸²à¸‡  
  - à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸šà¹ƒà¸«à¹‰à¸‚à¸­à¹€à¸žà¸´à¹ˆà¸¡  
â€¢ à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5) à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸ªà¸³à¸„à¸±à¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸šà¸­à¸à¸ˆà¸³à¸™à¸§à¸™ à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¸‹à¸·à¹‰à¸­ 1 à¸Šà¸´à¹‰à¸™ (à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸šà¸­à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² "(à¸–à¹‰à¸²à¸„à¸¸à¸“à¸žà¸µà¹ˆà¹„à¸¡à¹ˆà¸šà¸­à¸à¸ˆà¸³à¸™à¸§à¸™ à¸ˆà¸°à¸–à¸·à¸­à¸§à¹ˆà¸²à¸‹à¸·à¹‰à¸­ 1 à¹€à¸ªà¹‰à¸™à¸™à¸°à¸„à¸£à¸±à¸š)")
â€¢ à¸«à¸²à¸à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸šà¸—à¸ªà¸™à¸—à¸™à¸² à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸² â€œà¹€à¸”à¸µà¹‹à¸¢à¸§à¸•à¸²à¸¡à¹€à¸‹à¸µà¸¢à¸™à¸•à¹‰à¸²à¸£à¹Œà¸¡à¸²à¸•à¸­à¸šà¹ƒà¸«à¹‰à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆà¸™à¸°à¸„à¸£à¸±à¸šâ€  
â€¢ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸žà¸´à¸¡à¸žà¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‹à¹‰à¸³ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸²à¸¡  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸šà¸­à¸à¸ˆà¸³à¸™à¸§à¸™à¸­à¸‡à¸„à¹Œà¸«à¹‰à¸­à¸¢à¸žà¸£à¸°à¹€à¸Šà¹ˆà¸™ â€œà¸ªà¸£à¹‰à¸­à¸¢ 19 à¸­à¸‡à¸„à¹Œâ€ à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ 1 à¹€à¸ªà¹‰à¸™ à¹€à¸§à¹‰à¸™à¹à¸•à¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸šà¸­à¸à¹€à¸­à¸‡à¸§à¹ˆà¸²à¸«à¸¥à¸²à¸¢à¹€à¸ªà¹‰à¸™
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¸«à¸¥à¸²à¸¢à¸Šà¸´à¹‰à¸™ à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸£à¸§à¸¡à¸£à¸²à¸„à¸²à¸‚à¸­à¸‡à¸—à¸¸à¸à¸Šà¸´à¹‰à¸™à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¹à¸¥à¸°à¸šà¸§à¸à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡à¸•à¸²à¸¡à¸—à¸µà¸ªà¸¸à¸”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6) à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸šà¸šà¹€à¸•à¹‡à¸¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(à¸) à¸ªà¸£à¹‰à¸­à¸¢à¸ªà¸²à¸¢à¸„à¸²à¸”à¸‚à¹‰à¸²à¸‡
   â€¢ à¸—à¸³à¸ˆà¸²à¸à¸—à¸­à¸‡à¹€à¸«à¸¥à¸·à¸­à¸‡à¸Šà¸¸à¸šà¸™à¹‰à¸³à¸—à¸­à¸‡à¹à¸—à¹‰ à¸—à¸™à¸—à¸²à¸™ à¹„à¸¡à¹ˆà¸¥à¸­à¸ à¹„à¸¡à¹ˆà¸”à¸³  
   â€¢ à¸‚à¸™à¸²à¸”à¸«à¹‰à¸­à¸¢à¸žà¸£à¸°à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆ 5 à¸–à¸¶à¸‡ 30 à¸­à¸‡à¸„à¹Œ à¸ˆà¸°à¸ªà¸±à¹ˆà¸‡à¹à¸šà¸šà¸à¸µà¹ˆà¸­à¸‡à¸„à¹Œà¸à¹‡à¹„à¸”à¹‰ 
   â€¢ à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹€à¸Šà¸·à¸­à¸à¸¡à¸²à¸•à¸£à¸à¸²à¸™ 46 à¸™à¸´à¹‰à¸§ (à¸›à¸£à¸±à¸šà¹à¸à¹‰à¹„à¸”à¹‰à¸Ÿà¸£à¸µ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸à¸±à¸‡à¸§à¸¥à¸‚à¸™à¸²à¸”)  
   â€¢ à¸­à¸²à¸¢à¸¸à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸£à¸²à¸§ 3â€“6 à¹€à¸”à¸·à¸­à¸™ à¸ªà¸µà¸ˆà¸°à¸„à¹ˆà¸­à¸¢ à¹† à¸‹à¸µà¸”  
   â€¢ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸²à¸„à¸² (à¹„à¸¡à¹ˆà¸£à¸§à¸¡à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡ 50 à¸šà¸²à¸—):
       - 5 à¸­à¸‡à¸„à¹Œ: 290
       - 7 à¸­à¸‡à¸„à¹Œ: 350
       - 9 à¸­à¸‡à¸„à¹Œ: 390
       - 10 à¸­à¸‡à¸„à¹Œ: 420
       - 12 à¸­à¸‡à¸„à¹Œ: 460
       - 15 à¸­à¸‡à¸„à¹Œ: 520
       - 19 à¸­à¸‡à¸„à¹Œ: 570
       - 23 à¸­à¸‡à¸„à¹Œ: 770
       - 30 à¸­à¸‡à¸„à¹Œ: 990
   â€¢ à¸šà¸£à¸´à¸à¸²à¸£ COD à¸«à¸£à¸·à¸­à¹‚à¸­à¸™à¹„à¸”à¹‰  
   â€¢ à¸«à¸²à¸à¸à¸±à¸‡à¸§à¸¥à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‚à¸™à¸²à¸”à¸•à¸±à¸§ (à¸™à¸µà¹ˆà¸„à¸·à¸­à¸‚à¸™à¸²à¸”à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸²à¸”à¸‚à¹‰à¸²à¸‡):
     - à¸ªà¸¹à¸‡ â‰¤170 à¸‹à¸¡. / à¸™à¹‰à¸³à¸«à¸™à¸±à¸ â‰¤80 à¸à¸. à¹à¸™à¸°à¸™à¸³ 46 à¸™à¸´à¹‰à¸§
     - à¸ªà¸¹à¸‡ â‰¤180 à¸‹à¸¡. / à¸™à¹‰à¸³à¸«à¸™à¸±à¸ â‰¤90 à¸à¸. à¹à¸™à¸°à¸™à¸³ 48â€“50 à¸™à¸´à¹‰à¸§
     - à¸à¸£à¸“à¸µà¸­à¸·à¹ˆà¸™à¹ƒà¸«à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸•à¸²à¸¡à¸«à¸™à¹‰à¸²à¸‡à¸²à¸™
   â€¢ à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¸²à¸à¸—à¸³à¹€à¸›à¹‡à¸™à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­ à¹à¸™à¸°à¸™à¸³à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ 16-30 à¸™à¸´à¹‰à¸§ (à¸žà¸£à¹‰à¸­à¸¡à¸£à¸¹à¸›à¸›à¸£à¸°à¸à¸­à¸šà¸—à¸µà¹ˆà¸¡à¸µà¸‚à¸™à¸²à¸”à¸ªà¸£à¹‰à¸­à¸¢à¸„à¸­à¸—à¸µà¹ˆà¸¡à¸µ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¸–à¹‰à¸²à¸™à¸³à¹„à¸›à¸«à¹‰à¸­à¸¢à¸„à¸­)
   â€¢ à¸¡à¸µà¸—à¸¸à¸à¸‚à¸™à¸²à¸” à¸ˆà¸°à¹€à¸­à¸²à¸à¸µà¹ˆà¸­à¸‡à¸„à¹Œà¸à¹‡à¹„à¸”à¹‰ à¸­à¸´à¸‡à¸£à¸²à¸„à¸²à¸ˆà¸²à¸à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸²à¸„à¸²
   
(à¸‚) à¸ˆà¸°à¸¡à¸µà¹ƒà¸™à¸­à¸™à¸²à¸„à¸•
`;

// ------------------------
// Facebook Webhook Verify
// ------------------------
app.get('/webhook', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  if (mode === 'subscribe' && token === VERIFY_TOKEN) {
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

// ------------------------
// Facebook Webhook Receiver
// ------------------------
app.post('/webhook', async (req, res) => {
  const body = req.body;

  if (body.object === 'page') {
    body.entry.forEach(async (entry) => {
      const webhookEvent = entry.messaging[0];
      const senderId = webhookEvent.sender.id;

      // 1) à¸à¸£à¸“à¸µà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸à¸•à¸´
      if (webhookEvent.message && webhookEvent.message.text) {
        const messageText = webhookEvent.message.text;

        // à¸”à¸¶à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸Šà¸—à¸ˆà¸²à¸ MongoDB
        const history = await getChatHistory(senderId);

        // à¹€à¸£à¸µà¸¢à¸ Assistant (ChatGPT) à¹‚à¸”à¸¢à¸ªà¹ˆà¸‡ System Instructions + à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸ªà¸™à¸—à¸™à¸² + à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ
        const assistantResponse = await getAssistantResponse(history, messageText);

        // à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¹ƒà¸«à¸¡à¹ˆà¸¥à¸‡à¹ƒà¸™ MongoDB
        await saveChatHistory(senderId, messageText, assistantResponse);

        // à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸²à¸‡ Messenger
        sendTextMessage(senderId, assistantResponse);

      }
      // 2) à¸à¸£à¸“à¸µà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸› (à¸«à¸£à¸·à¸­ attachment) à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µ text
      else if (webhookEvent.message && webhookEvent.message.attachments) {
        const attachments = webhookEvent.message.attachments;
        let isImageFound = false;

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸ à¸²à¸žà¹ƒà¸™ attachments à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        for (let att of attachments) {
          if (att.type === 'image') {
            isImageFound = true;
            break;
          }
        }

        if (isImageFound) {
          // à¸«à¸²à¸à¸žà¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¸ à¸²à¸ž à¹ƒà¸«à¹‰à¸šà¸­à¸ ChatGPT à¸§à¹ˆà¸² â€œà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²â€
          const userMessage = "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²**";

          // à¸”à¸¶à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸Šà¸—
          const history = await getChatHistory(senderId);

          // à¹€à¸£à¸µà¸¢à¸ Assistant
          const assistantResponse = await getAssistantResponse(history, userMessage);

          // à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡à¹ƒà¸™ MongoDB
          await saveChatHistory(senderId, userMessage, assistantResponse);

          // à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
          sendTextMessage(senderId, assistantResponse);
        } else {
          // à¸«à¸²à¸à¹€à¸›à¹‡à¸™à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸­à¸·à¹ˆà¸™ à¹€à¸Šà¹ˆà¸™ location, file, audio...
          const userMessage = "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›**";
          const history = await getChatHistory(senderId);
          const assistantResponse = await getAssistantResponse(history, userMessage);

          await saveChatHistory(senderId, userMessage, assistantResponse);

          sendTextMessage(senderId, assistantResponse);
        }
      }
    });
    res.status(200).send('EVENT_RECEIVED');
  } else {
    res.sendStatus(404);
  }
});

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: getChatHistory
// ------------------------
async function getChatHistory(senderId) {
  try {
    // à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ client global
    const client = await connectDB();
    const db = client.db("chatbot");
    const collection = db.collection("chat_history");

    // à¸”à¸¶à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸Šà¸—
    const chats = await collection.find({ senderId }).sort({ timestamp: 1 }).toArray();

    // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¸²à¸¡ role: "user"
    return chats.map((chat) => ({
      role: "user",
      content: chat.message,
    }));
  } catch (error) {
    console.error("Error fetching chat history:", error);
    return [];
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: getAssistantResponse
// ------------------------
async function getAssistantResponse(history, message) {
  try {
    // à¸£à¸§à¸¡ system instructions + history + user message
    const messages = [
      { role: "system", content: systemInstructions },
      ...history,
      { role: "user", content: message },
    ];

    // à¹€à¸£à¸µà¸¢à¸à¹‚à¸¡à¹€à¸”à¸¥à¸œà¹ˆà¸²à¸™ OpenAI API (à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸·à¹ˆà¸­à¹‚à¸¡à¹€à¸”à¸¥à¸•à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£)
    const response = await openai.chat.completions.create({
      model: "gpt-4o", // à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹‚à¸¡à¹€à¸”à¸¥
      messages: messages,
    });

    return response.choices[0].message.content;
  } catch (error) {
    console.error("Error with ChatGPT Assistant:", error);
    return "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š Assistant";
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: saveChatHistory
// ------------------------
async function saveChatHistory(senderId, message, response) {
  try {
    // à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ client global
    const client = await connectDB();
    const db = client.db("chatbot");
    const collection = db.collection("chat_history");

    const chatRecord = {
      senderId,
      message,
      response,
      timestamp: new Date(),
    };
    await collection.insertOne(chatRecord);

    console.log("à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸Šà¸—à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
  } catch (error) {
    console.error("Error saving chat history:", error);
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendTextMessage (à¸£à¸­à¸‡à¸£à¸±à¸šà¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›à¸žà¸£à¹‰à¸­à¸¡à¸à¸±à¸™)
// ------------------------
function sendTextMessage(senderId, response) {
  // Regex à¹à¸šà¸š global à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸±à¸šà¸«à¸¥à¸²à¸¢à¸„à¸³à¸ªà¸±à¹ˆà¸‡ [SEND_IMAGE_XXX:URL]
  const imageRegex = /\[SEND_IMAGE_(SROI|LENGTH):(https?:\/\/[^\s]+)\]/g;

  // matchAll à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡ match à¸«à¸¥à¸²à¸¢à¸£à¸²à¸¢à¸à¸²à¸£
  const matches = [...response.matchAll(imageRegex)];

  // à¸•à¸±à¸”à¸„à¸³à¸ªà¸±à¹ˆà¸‡ [SEND_IMAGE_XXX:URL] à¸­à¸­à¸à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  let textPart = response.replace(imageRegex, '').trim();

  // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (à¸–à¹‰à¸²à¸¡à¸µ text à¹€à¸«à¸¥à¸·à¸­)
  if (textPart.length > 0) {
    sendSimpleTextMessage(senderId, textPart);
  }

  // à¸§à¸™à¸¥à¸¹à¸›à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸—à¸µà¸¥à¸° match
  matches.forEach(match => {
    const imageUrl = match[2];  // URL = match[2] à¸ˆà¸²à¸ pattern
    sendImageMessage(senderId, imageUrl);
  });
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendSimpleTextMessage
// ------------------------
function sendSimpleTextMessage(senderId, text) {
  const requestBody = {
    recipient: { id: senderId },
    message: { text: text },
  };

  request({
    uri: 'https://graph.facebook.com/v12.0/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: requestBody,
  }, (err, res, body) => {
    if (!err) {
      console.log('à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
    } else {
      console.error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡:', err);
    }
  });
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendImageMessage
// ------------------------
function sendImageMessage(senderId, imageUrl) {
  const requestBody = {
    recipient: { id: senderId },
    message: {
      attachment: {
        type: 'image',
        payload: {
          url: imageUrl,
          is_reusable: true,
        },
      },
    },
  };

  request({
    uri: 'https://graph.facebook.com/v12.0/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: requestBody,
  }, (err, res, body) => {
    if (!err) {
      console.log('à¸£à¸¹à¸›à¸ à¸²à¸žà¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
    } else {
      console.error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž:', err);
    }
  });
}

// ------------------------
// Start Server
// ------------------------
app.listen(PORT, async () => {
  console.log(`Server is running on port ${PORT}`);
  // à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MongoDB à¸•à¸­à¸™à¸ªà¸•à¸²à¸£à¹Œà¸—à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¹€à¸«à¸¡à¸·à¸­à¸™à¹‚à¸„à¹‰à¸”à¸—à¸µà¹ˆ 1)
  try {
    await connectDB();
  } catch (err) {
    console.error("MongoDB connect error at startup:", err);
  }
});
